import os
import json
from typing import Tuple, Dict, Any
from django.http import JsonResponse, HttpRequest
from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_http_methods
from textwrap import dedent
from openai import OpenAI

PARSED_START = "<<PARSED_PAYLOAD_JSON_START>>"
PARSED_END   = "<<PARSED_PAYLOAD_JSON_END>>"

# ---------- ë‚´ë¶€ í˜¸ì¶œìš© í•µì‹¬ ë¡œì§ ----------
def run_checkreport_gpt(parsed_payload: dict, debug: bool = False) -> Tuple[dict, Dict[str, Any]]:
    """
    í•©ì³ì§„ ì›ë³¸ ì „ì²´ JSON(parsed_payload)ì„ ê·¸ëŒ€ë¡œ GPTì— ì „ë‹¬í•˜ì—¬
    í…Œì´ë¸” ë Œë”ë§ìš© ìŠ¤í‚¤ë§ˆ(JSON)ë¡œ ë³€í™˜.

    ë°˜í™˜:
      - result: {"version":"1","total":N,"items":[...]}
      - debug_payload:
          {
            "gpt_request": {...},          # ì‹¤ì œ ë³´ë‚¼ ì „ì²´ íŒŒë¼ë¯¸í„° (ì˜¤ë¥˜ ì‹œì—ë„ ì±„ì›€)
            "gpt_response_meta": {...},    # í˜¸ì¶œ ì„±ê³µ ì‹œ ë©”íƒ€
            "instruction_text": "...",     # ì‚¬ëŒì´ ì½ê¸° ì‰½ê²Œ ì›ë¬¸ ë…¸ì¶œ
            "error": "..."                 # í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€
          }
    """
    debug_payload: Dict[str, Any] = {}

    # 0) instruction ì›ë¬¸ ë° ìŠ¤í‚¤ë§ˆ(ì—¬ëŸ¬ ì¤„ ê·¸ëŒ€ë¡œ)
    instruction_text = dedent("""\
        <<PARSED_PAYLOAD_JSON_START>> ~ <<PARSED_PAYLOAD_JSON_END>> ì‚¬ì´ì— ì œê³µë˜ëŠ” json ê°’(ì´í•˜ 'ì›ë³¸')ì€ ì‹œí—˜ê²°ê³¼ì„œ íŒŒì¼(.docx)ë¥¼ íŒŒì‹±í•´ í•˜ë‚˜ì˜ JSONìœ¼ë¡œ í•©ì¹œ ë°ì´í„°ì…ë‹ˆë‹¤.
        ì•„ë˜ êµ¬ì¡°ë¥¼ ì°¸ê³ í•˜ì—¬ ì›ë³¸ì„ í•˜ë‚˜ì˜ word ë¬¸ì„œë¡œ ë§Œë“¤ì–´ 'íŒë‹¨ ì§€ì¹¨'ì— ë”°ë¼ ê²°ê³¼ë¥¼ ì œê³µí•´ì¤˜.

        ### ì›ë³¸ êµ¬ì¡° ì„¤ëª… ###
        ## 1) ìµœìƒìœ„ êµ¬ì¡°
        {
          "v": "1",
          "docx": {
            "v": "1",
            "content": [ /* ë…¸ë“œ ë°°ì—´(ì›ë¬¸ ìˆœì„œ ë³´ì¡´) */ ]
          },
          "pdf": {
            "v": "1",
            "total_pages": 0,
            "pages": [
              { "page": 1, "header": ["ìƒë‹¨ 1ì¤„"], "footer": ["í•˜ë‹¨ 1ì¤„"] }
            ]
          }
        }
        ìš”ì†Œ ì„¤ëª…
        - v: ìŠ¤í‚¤ë§ˆ ë²„ì „(ë¬¸ìì—´, ì„ì˜ ê°’)
        - docx: DOCX ë³¸ë¬¸ íŒŒì‹± ê²°ê³¼
        - pdf: PDF ê° í˜ì´ì§€ ìƒë‹¨/í•˜ë‹¨ 1ì¤„ í…ìŠ¤íŠ¸ ê²°ê³¼
        ---
        ## 2) DOCX
        ### 2.1 content ë…¸ë“œ íƒ€ì…
        1) ë¬¸ì¥ ë…¸ë“œ
        { "sen": "ë¬¸ë‹¨/ììœ  í…ìŠ¤íŠ¸(OMML ìˆ˜ì‹ ì„ í˜• í¬í•¨)" }
        2) ë¼ë²¨(ì„¹ì…˜) ë…¸ë“œ
        { "label": "ì œëª©/ë²ˆí˜¸/ì²¨ë¶€", "content": [ /* í•˜ìœ„ ë…¸ë“œë“¤ */ ] }
        - ë¼ë²¨ íŒ¨í„´ ì˜ˆ: ìˆ«ì ì„¹ì…˜(^\\d+(\\.\\d+)*\\s+), ì²¨ë¶€(^<\\s*ì²¨ë¶€\\s*\\d+\\s*>)
        3) í‘œ ë…¸ë“œ
        {
          "table": [
            [row, col, row_span, col_span, "ì…€ í…ìŠ¤íŠ¸"],
            ...
          ]
        }
        - ì¢Œí‘œ 1-based
        - ë³‘í•© ì •ë³´ ìœ ì§€(ë£¨íŠ¸ ì…€ë§Œ ê¸°ë¡)
        - "ì…€ í…ìŠ¤íŠ¸"ëŠ” ì—¬ëŸ¬ ë¬¸ë‹¨ì„ \\n ë¡œ ì—°ê²°
        - í‘œ ë‚´ë¶€ ìˆ˜ì‹ ì—­ì‹œ ì„ í˜•í™”ëœ í…ìŠ¤íŠ¸ë¡œ í¬í•¨
        ### 2.2 ëª©ì°¨(TOC)
        - "ëª© ì°¨" êµ¬ê°„: ì „ë¶€ senë§Œ ìƒì„±(ë¼ë²¨/í‘œ ì—†ìŒ)
        ### 2.3 OMML ìˆ˜ì‹ ì„ í˜•í™” ê·œì¹™(ë¬¸ì¥/í‘œ í…ìŠ¤íŠ¸ì— í¬í•¨)
        - ë¶„ìˆ˜: (ë¶„ì)/(ë¶„ëª¨)
        - ì•„ë«/ìœ—ì²¨ì: x_{i}, x^{2}, x_{i}^{n}
        - ì‹œê·¸ë§ˆ/íŒŒì´: âˆ‘_{í•˜í•œ}^{ìƒí•œ} (...), ìƒÂ·í•˜í•œì´ ë¹„ì–´ìˆìœ¼ë©´ ìƒëµ(ì˜ˆ: âˆ‘ (...))
        - ì˜ˆì‹œ(ê¸°ëŒ€ í‘œí˜„):
          X(%) = âˆ‘_{i=1}^{n} (A_{i}+B_{i})/(n)
          Y(%) = âˆ‘_{i=1}^{n} (C_{i}-(D_{i}+E_{i}+F_{i}))/(C_{i})*(1)/(n)*(1)/(1024)*100
        ---
        ## 3) PDF
        êµ¬ì¡°
        "pdf": {
          "v": "1",
          "total_pages": 15,
          "pages": [
            { "page": 1, "header": ["ìƒë‹¨ 1ì¤„"], "footer": ["í•˜ë‹¨ 1ì¤„"] },
            ...
          ]
        }
        ì„¤ëª…
        - ê° í˜ì´ì§€ ìƒë‹¨ 1ì¤„ â†’ header([] ë¬¸ìì—´ ë°°ì—´)
        - ê° í˜ì´ì§€ í•˜ë‹¨ 1ì¤„ â†’ footer([] ë¬¸ìì—´ ë°°ì—´)
        - ì˜ˆ:
          header: "1/12 ì†Œí”„íŠ¸ì›¨ì–´ì‹œí—˜ì¸ì¦ì—°êµ¬ì†Œ"
          footer: "TPG-1016-5(02)  Copyright 2025 TTA  í˜ì´ì§€ : (7)/(ì´15)"
        ---
        ### ì›ë³¸ êµ¬ì¡° ì„¤ëª… ë ###

        ### íŒë‹¨ ì§€ì¹¨ ì‹œì‘ ###
        Let's think step by step
        ## ì—­í• 
        - ë‹¹ì‹ ì€ **ì‹œí—˜ í•©ì˜ì„œ/ì‹œí—˜ê²°ê³¼ì„œ ê¸°ìˆ ì±…ì„ì**ì…ë‹ˆë‹¤.
        - **ë¬¸ì„œì— ì¡´ì¬í•˜ëŠ” ê·¼ê±°ë¡œë§Œ** íŒë‹¨í•˜ì„¸ìš”. ë¬¸ì„œì— ì—†ëŠ” ì‚¬ì‹¤Â·ìˆ˜ì¹˜Â·í˜ì´ì§€Â·ê·¸ë¦¼Â·í‘œëŠ” **ì¶”ì •/ìƒì„± ê¸ˆì§€**. ë¶ˆí™•ì‹¤í•˜ë©´ **â€œê²€ì¦ë¶ˆê°€(ê·¼ê±° ì—†ìŒ)â€**ìœ¼ë¡œ í‘œê¸°.

        ## ë³´ê³  ì›ì¹™
        - ìµœìš°ì„ : **ìˆ˜ì‹/ì‚°ì‹ ì˜¤ë¥˜ ê²€ì¦ ë° ì¬ê³„ì‚°**.
        - **ëŒ€ì†Œë¬¸ìÂ·ì‚¬ì†Œí•œ ë„ì–´ì“°ê¸°Â·ê²½ë¯¸í•œ ë¬¸ì²´**ëŠ” ë³´ê³ í•˜ì§€ ì•ŠìŒ(ì˜ë¯¸Â·ê³„ì‚° ì˜í–¥ ì‹œë§Œ ë³´ê³ ).
        - ê°€ëŠ¥í•˜ë©´ **í˜ì´ì§€Â·ìœ„ì¹˜(í‘œ/ì ˆ/ë¬¸ì¥)**ë¥¼ í•¨ê»˜ ëª…ì‹œ(ë¶ˆëª…í™• ì‹œ â€œí˜ì´ì§€ ë¶ˆëª…â€).

        ## ì‹¬ê°ë„(ì•„ì´ì½˜)
        - ğŸŸ¥ **ì‹¬ê°**: ì‚°ì‹ì˜¤ë¥˜ë¡œ ê²°ê³¼ ì™œê³¡, ì‹œí—˜í™˜ê²½/ì‚¬ì–‘ ì¤‘ëŒ€ ë¶ˆì¼ì¹˜, ì•ˆì „Â·ê·œì œ/ë²„ì „/ì˜ë¢°ì/ë²ˆí˜¸/ê¸°ê°„ ë¶ˆì¼ì¹˜
        - ğŸŸ§ **ì¤‘ìš”**: í•µì‹¬ ê¸°ìˆ  ë¶ˆì¼ì¹˜, ë‹¨ìœ„Â·ì¹˜ìˆ˜ ì˜¤ë¥˜, ê²°ë¡ ì— ì˜í–¥ ì£¼ëŠ” í•„ìˆ˜ í•­ëª© ëˆ„ë½
        - ğŸŸ¨ **ë³´í†µ**: ë¹„ë…¼ë¦¬Â·ë¶ˆëª…í™• ì„œìˆ , ë¬¸ë§¥ ìœ ì‚¬ë„ ê¸°ì¤€ ë¯¸ë‹¬
        - ğŸŸ¦ **ê²½ë¯¸**: ìš©ì–´ ë¹„í‘œì¤€/í‘œí˜„ ê°œì„ (ì˜ë¯¸ ë™ì¼)

        ## í•„ìˆ˜ ì ê²€í•­ëª©
        1. **ì˜¤íƒ€(ì˜ë¯¸ ë³€í˜•)**
        2. **ê¸°ìˆ  ì˜¤ë¥˜**: ìš”êµ¬ì‚¬í•­Â·ì‚¬ì–‘Â·ê²°ê³¼ ìƒì¶©, ë‹¨ìœ„/ì¹˜ìˆ˜/ë²”ìœ„ ì˜¤ë¥˜
        3. **ìš©ì–´Â·ìˆ˜ì¹˜ ì¼ê´€ì„±**
        4. **ë¹„ë…¼ë¦¬ ë¬¸ì¥**(ê·¼ê±° ì—†ëŠ” ë‹¨ì • í¬í•¨)
        5. **ìˆ˜ì‹/ì‚°ì‹ ì˜¤ë¥˜**: ê¸°í˜¸Â·ë‹¨ìœ„Â·ë°˜ì˜¬ë¦¼Â·%â†”ì†Œìˆ˜ í˜¼ë™Â·ëŒ€ì…ê°’ ë¶ˆì¼ì¹˜
        6. **ê¸°ëŠ¥ë¦¬ìŠ¤íŠ¸ ê°€ë…ì„±**(CRUDSM ê´€ì )
        7. **<ì²¨ë¶€1> ê¸°ëŠ¥ë¦¬ìŠ¤íŠ¸ ê·œì¹™ ì¤€ìˆ˜**
        8. **ê²°ë§ ë¬¸ìì—´**: ë¬¸ì„œ ë§ˆì§€ë§‰ì— â€œ- ë -â€ ë˜ëŠ” â€œ-ë-â€ ì¡´ì¬
        9. **ë‹¨ì–´ ìœ ì‚¬ë„(5.1 ê¸°ëŠ¥ì í•©ì„± â†” <ì²¨ë¶€1>)**: ìœ ì‚¬ë„ â‰¤ 30%ë©´ ì˜¤ë¥˜(ë³´í†µ)
        10. **ì‹œí—˜í™˜ê²½ ì¼ì¹˜(4.2)**: **<ì‹œí—˜í™˜ê²½êµ¬ì„±ë„> â†” <ì„¸ë¶€ì‚¬ì–‘> í‘œ** ë™ì¼
        11. **ëª©ì°¨ í˜ì´ì§€ ì¼ì¹˜(3í˜ì´ì§€)**
        12. **ì œì¡°ì í‘œê¸°**: 4.1 ì œí’ˆêµ¬ì„±ì˜ ì œì¡°ì â†” 1.1 íšŒì‚¬ ê°œìš”ì˜ íšŒì‚¬ëª… ì¼ì¹˜
        13. **ì„¤ì¹˜ SW í‘œê¸° ì •í™•ì„±(<ì„¸ë¶€ì‚¬ì–‘>)**: ì˜¤í”ˆì†ŒìŠ¤/SWëª… ì˜¤ë¥˜ ì—¬ë¶€
        14. **ì œí’ˆ êµ¬ì„±(4.1)**: ì œí’ˆëª…(êµ­ë¬¸ ë˜ëŠ” ì˜ë¬¸) í¬í•¨
        15. **ì„¸ë¶€ì‚¬ì–‘ í‘œê¸° ëª…í™•ì„±**: OS, CPU í‘œê¸° ì˜¤ë¥˜ ì—†ìŒ(ì˜ˆ: IntelÂ® Xeonâ€¦ í˜•ì‹ ì¼ê´€)
        16. **Copyright ì—°ë„ = 6. ì‹œí—˜ê¸°ê°„ ì¢…ë£Œì—°ë„(1í˜ì´ì§€)**
        17. **ëª©ì°¨ ë²ˆí˜¸ ì˜¤ë¥˜(3í˜ì´ì§€)**
        18. **ë‹¨ì–´ ìœ ì‚¬ë„(1.2 ê°œìš” ë° íŠ¹ì„± â†” <ì²¨ë¶€1>)**: ìœ ì‚¬ë„ â‰¤ 30%ë©´ ì˜¤ë¥˜(ë³´í†µ)
        19. **ëª©ì ê²© ì¡°ì‚¬ ëˆ„ë½**(ì„/ë¥¼ ë“±)

        ### BTë¡œ ì‹œì‘í•˜ëŠ” ê²°ê³¼ì„œ ì¶”ê°€ ì ê²€
        - 3. ì‹œí—˜í•­ëª© **ì¸¡ì •ì§€í‘œ ì‚°ì‹ ê²€ì¦**
        - 3 â†” 5(ì‹œí—˜ë°©ë²•) â†” 6(ì‹œí—˜ê²°ê³¼) **í•­ëª© ì¼ê´€ì„±**
        - 7. ì‹œí—˜ê¸°ë¡ **ìˆ«ì ê³„ì‚° ê²€ì¦**

        ## ë¬¸ë§¥ ìœ ì‚¬ë„(ì¬í˜„ ì ˆì°¨)
        (a) ê°œìš”Â·ê¸°ëŠ¥ë¦¬ìŠ¤íŠ¸Â·5.1ì—ì„œ **í•µì‹¬ í‚¤ì›Œë“œ 10~30ê°œ**ì”© ì¶”ì¶œ â†’  
        (b) **ë™ë“±ì–´ë§Œ ë³‘í•©**(ì˜ˆ: IP ì£¼ì†Œ=IP Address, í¬íŠ¸ ë²ˆí˜¸=Port Number) â†’  
        (c) **ìœ ì‚¬ë„ = êµì§‘í•©/í•©ì§‘í•© Ã— 100%** â†’  
        (d) **50% ì´í•˜**ëŠ” ë³´í†µìœ¼ë¡œ ë³´ê³ (ê²¹ì¹˜ëŠ”/ëˆ„ë½ í‚¤ì›Œë“œ ì˜ˆì‹œ ì¸ìš©).

        ## ì‚°ì‹/ìˆ˜ì¹˜ ê²€ì¦ ì ˆì°¨
        1) **ê¸°í˜¸Â·ë³€ìˆ˜Â·ë‹¨ìœ„ ì •ì˜ í™•ì¸**  
        2) **ì°¨ì› ì¼ì¹˜**(MB/s vs Mb/s, Â°C vs K, ms vs s ë“±)  
        3) **ëŒ€ì… ì¬ê³„ì‚°** + **ë°˜ì˜¬ë¦¼ ê·œì¹™** í™•ì¸  
        4) **%â†”ì†Œìˆ˜ ë³€í™˜ ì¼ê´€ì„±**  
        5) **ìƒÂ·í•˜í•œ/í—ˆìš©ì˜¤ì°¨** ëŒ€ë¹„  
        6) ë°ì´í„° ë¶€ì¡± ì‹œ **â€œê²€ì¦ë¶ˆê°€(ìˆ˜ì¹˜/ë‹¨ìœ„ ë¶€ì¬)â€**

        ## <ì²¨ë¶€1> ê¸°ëŠ¥ë¦¬ìŠ¤íŠ¸ ê·œì¹™(ìš”ì•½)
        - **CRUDSM** ê´€ì  ê¸°ìˆ (ë“±ë¡/ì¡°íšŒ/ìˆ˜ì •/ì‚­ì œë§Œë„ í—ˆìš©).
        - **ê¸ˆì§€**: ì‚¬ëŒ í–‰ìœ„ ì§€ì‹œ ë‹¨ì–´(ì„œë¹„ìŠ¤/ì²˜ë¦¬/ë‚´ì—­ ë“±), â€œì„¤ì •(ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ)â€ ëª¨í˜¸ í‘œí˜„.
        - **ê°œì„  ê°€ì´ë“œ**:
          - â€œí˜„í™©/ê¸°ë¡/ë¡œê·¸/ì´ë ¥â€ â†’ **ê´„í˜¸ë¡œ êµ¬ì²´í™”**(ì˜ˆ: *ì´ë ¥(ì‹œê°, ì´ë¦„, ì´ë²¤íŠ¸ ë“±) ì¡°íšŒ*).
          - í˜•ì‹ ëª…ì‹œ(ì˜ˆ: *ë°ì´í„° ì¡°íšŒ REST API*, *ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ*).
          - **IP ì£¼ì†Œ**, **í¬íŠ¸ ë²ˆí˜¸**, **URL ì£¼ì†Œ**ë¡œ í‘œì¤€í™”.

        ## ì œì™¸Â·ë¬´ì‹œ(ë³´ê³ í•˜ì§€ ì•ŠìŒ)
        - í…œí”Œë¦¿Â·ê¼¬ë¦¬ë§ í˜¼ì¬, 5~7í˜ì´ì§€ ì „ë©´, í™˜ê²½ ëª¨í˜¸ ì„œìˆ  ë“± **ì œì™¸ ë¦¬ìŠ¤íŠ¸**ì— í•´ë‹¹í•˜ëŠ” í•­ëª©.
        - **ì‚°ì •ì‹ ëˆ„ë½ ìì²´**, Working Day ì¼ë°˜, ì„¤ì¹˜ SW ì—´ì˜ HW í˜¼ì… ë“±ì€ **ì ê²€ ì œì™¸ ê·œì •** ì¤€ìˆ˜.

        ## 1.2 ê°œìš” ë° íŠ¹ì„±
        - **ì£¼ìš” ê¸°ëŠ¥ ì„¤ëª… í•„ìˆ˜**.
        - **ì£¼ìš” ê¸°ëŠ¥ ì•„ë‹˜**(ì œì™¸): ì‚¬ìš©ì ê´€ë¦¬/ë¡œê·¸ì¸ ë“± â†’ ì‹¤ì œ í•µì‹¬ ê¸°ëŠ¥ìœ¼ë¡œ ëŒ€ì²´ ê¶Œê³ .

        ## ì¶œë ¥ í˜•ì‹(ë°˜ë“œì‹œ ì¤€ìˆ˜)
        - **ì–‘í˜¸ í•­ëª©ì€ ì¶œë ¥ ê¸ˆì§€. ì˜¤ë¥˜ë§Œ jsonìœ¼ë¡œ ìš”ì•½.**
        - **í˜ì´ì§€ ë¶ˆëª…** ì‹œ ìœ„ì¹˜ì— â€œ-â€ í‘œê¸°.
        - **ìˆ˜ì •ì•ˆì€ ê°„ê²°Â·êµ¬ì²´Â·ê²€ì¦ê°€ëŠ¥**í•˜ê²Œ.
        - **ì˜¤ë¥˜ê°€ ì „í˜€ ì—†ìœ¼ë©´**: null ì¶œë ¥.
        - **ì•„ë˜ ìŠ¤í‚¤ë§ˆì˜ JSON ê°ì²´ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.
        {{
            "version": "1",
            "total": "items ë°°ì—´ ê¸¸ì´",
            "items": [{
                "no": "1ë¶€í„° ì‹œì‘í•˜ëŠ” ë²ˆí˜¸(ì •ìˆ˜)",
                "category": "êµ¬ë¶„(ì ê²€í•­ëª©)",
                "severity": "ì‹¬ê°ë„",
                "location": "ìœ„ì¹˜(í‘œ/ì ˆ/ë¬¸ì¥)",
                "summary": "ë¬¸ì œ ìš”ì•½",
                "evidence": "ê·¼ê±°(ì›ë¬¸ ì¼ë¶€ ì¸ìš©, 10~30ì)",
                "recommendation": "ê¶Œì¥ ìˆ˜ì •ì•ˆ"
            }]
        }}

        ## ì •ë ¬Â·ë§ˆê°
        - **ì¤‘ìš”ë„ ìˆœ(ğŸŸ¥â†’ğŸŸ§â†’ğŸŸ¨â†’ğŸŸ¦)** ì •ë ¬.
        - ë¬¸ì„œ ë **ê²°ë§ ë¬¸ìì—´**(â€œ- ë -â€ ë˜ëŠ” â€œ-ë-â€) ì¡´ì¬ í™•ì¸.
        - **ì¶”ê°€ ê°€ì • ê¸ˆì§€**, ìˆ˜ì¹˜Â·ìœ ì‚¬ë„Â·í˜ì´ì§€ëŠ” **ì§€ì–´ë‚´ì§€ ë§ ê²ƒ**. ë¶€ì¡±í•˜ë©´ **ê²€ì¦ë¶ˆê°€**ë¡œ.
        ### íŒë‹¨ ì§€ì¹¨ ë ###
    """).strip()

    # 1) ì‹¤ì œë¡œ ë³´ë‚¼ 'ìš”ì²­ í˜ì´ë¡œë“œ'ë¥¼ ì„ êµ¬ì„± (ì˜¤ë¥˜ì—¬ë„ ë””ë²„ê·¸ì— ë„£ê¸° ìœ„í•¨)
    request_payload: Dict[str, Any] = {
        "model": "gpt-5-nano",
        "response_format": {"type": "json_object"},
        "messages": [
            {
                "role": "system",
                "content": "You are a strict technical reviewer. Return ONLY a JSON object in the required schema."
            },
            {
                "role": "user",
                "content": json.dumps(instruction_text, ensure_ascii=False)
            },
            {
                "role": "user",
                "content": f"{PARSED_START}\n{json.dumps(parsed_payload, ensure_ascii=False)}\n{PARSED_END}"
            }
        ],
    }

    # 2) ë””ë²„ê·¸ ì¼œì§„ ê²½ìš°, í˜¸ì¶œ ì „ë¶€í„° gpt_request/instruction_textë¥¼ ì±„ì›Œë‘ 
    if debug:
        debug_payload["gpt_request"] = request_payload
        debug_payload["instruction_text"] = instruction_text

    # 3) API í‚¤ í™•ì¸ â†’ ì—†ìœ¼ë©´ í˜¸ì¶œí•˜ì§€ ì•Šê³  ì¦‰ì‹œ ë¹ˆ ê²°ê³¼ + ë””ë²„ê·¸ ë°˜í™˜
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        if debug:
            debug_payload["error"] = "OPENAI_API_KEY is not set (ëª¨ë¸ í˜¸ì¶œ ìƒëµ)."
        return {"version": "1", "total": 0, "items": []}, debug_payload

    # 4) ì‹¤ì œ í˜¸ì¶œ
    try:
        client = OpenAI(api_key=api_key)
        completion = client.chat.completions.create(**request_payload)

        content = completion.choices[0].message.content if completion.choices else None
        data = json.loads(content) if content else {"version": "1", "total": 0, "items": []}

        # 5) ìŠ¤í‚¤ë§ˆ ì •ê·œí™”
        items = data.get("items", [])
        norm = []
        for idx, it in enumerate(items, start=1):
            norm.append({
                "no":              it.get("no", idx),
                "category":        it.get("category", ""),
                "severity":        it.get("severity", ""),
                "location":        it.get("location", ""),
                "summary":         it.get("summary", ""),
                "evidence":        it.get("evidence", ""),
                "recommendation":  it.get("recommendation", "")
            })
        result = {"version": "1", "total": len(norm), "items": norm}

        # 6) ë””ë²„ê·¸ ë©”íƒ€ (ì„±ê³µ ì‹œ)
        if debug:
            usage = getattr(completion, "usage", None)
            debug_payload["gpt_response_meta"] = {
                "id": getattr(completion, "id", None),
                "created": getattr(completion, "created", None),
                "model": getattr(completion, "model", None),
                "usage": {
                    "prompt_tokens": getattr(usage, "prompt_tokens", None) if usage else None,
                    "completion_tokens": getattr(usage, "completion_tokens", None) if usage else None,
                    "total_tokens": getattr(usage, "total_tokens", None) if usage else None,
                }
            }

        return result, debug_payload

    except Exception as e:
        # 7) ì‹¤íŒ¨ ì‹œì—ë„ ë””ë²„ê·¸ì— ì˜¤ë¥˜ë¥¼ ë‚¨ê¹€
        if debug:
            debug_payload["error"] = f"OpenAI call failed: {e}"
        return {"version": "1", "total": 0, "items": []}, debug_payload


# ---------- (ì„ íƒ) í•˜ìœ„í˜¸í™˜ìš© ì—”ë“œí¬ì¸íŠ¸ ----------
@csrf_exempt
@require_http_methods(["POST"])
def get_gpt_recommendation_view(request: HttpRequest):
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        return JsonResponse({"error": "OPENAI_API_KEY í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}, status=500)

    client = OpenAI(api_key=api_key)

    try:
        body = json.loads(request.body.decode("utf-8") or "{}")
        user_prompt = body.get("prompt", "")

        completion = client.chat.completions.create(
            model="gpt-5-nano",
            messages=[
                {"role": "system", "content": "You are a helpful assistant."},
                {"role": "user", "content": user_prompt}
            ]
        )
        response_content = completion.choices[0].message.content if completion.choices else ""
        return JsonResponse({"response": response_content})
    except Exception as e:
        msg = str(e)
        if "The model `gpt-5-nano` does not exist" in msg:
            msg = "GPT ëª¨ë¸('gpt-5-nano')ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª¨ë¸ëª…ì„ í™•ì¸í•˜ê±°ë‚˜ OpenAI API Planì„ í™•ì¸í•˜ì„¸ìš”."
        return JsonResponse({"error": f"GPT API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {msg}"}, status=500)
